global
    log /dev/log local0 warning
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon
    maxconn 20000
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

defaults
    log global
    option dontlognull
    option clitcpka
    option srvtcpka
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# =============================================================================
# 前端配置 - HTTP (80端口) - 混合模式：特定域名TCP转发，其他重定向HTTPS
# =============================================================================
frontend http-in
    bind *:80
    mode tcp
    
    # TCP请求检查延迟
    tcp-request inspect-delay 5s
    tcp-request content accept if HTTP
    
    # 特定域名直接在80端口处理，不重定向到HTTPS（使用TCP模式）
    use_backend caddy_servers_80 if { req.hdr(host) -i www.123.cc }
    use_backend caddy_servers_80 if { req.hdr(host) -i 123.cc }
    
    # 其他所有域名使用HTTP模式重定向后端处理
    default_backend http_redirect_backend

# =============================================================================
# 前端配置 - HTTPS (443端口) - 保留原有功能
# =============================================================================
frontend tcp_front_443
    bind *:443
    mode tcp
    rate-limit sessions 8000
    
    # SSL SNI 检查配置
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }
    
    
    # Caddy 后端域名配置
    use_backend caddy_servers_443 if { req_ssl_sni -i www.456.cc }
    use_backend caddy_servers_443 if { req_ssl_sni -i 456.cc }
    
    # 默认后端（处理无法匹配的域名，如直接IP访问等）
    default_backend caddy_servers_443

# =============================================================================
# 后端配置 - Caddy 服务器 (80端口) - TCP模式
# =============================================================================
backend caddy_servers_80
    mode tcp
    
    # 主 Caddy 服务器 - TCP模式，80端口
    server Caddy1_80 6.6.6.6:80 check inter 10s rise 2 fall 3
    
    # 备用 Caddy 服务器（可选）
    # server Caddy2_80 8.8.8.8:80 check inter 10s rise 2 fall 3 backup

# =============================================================================
# 后端配置 - HTTP重定向处理
# =============================================================================
backend http_redirect_backend
    mode http
    # 所有其他HTTP流量强制跳转HTTPS
    redirect scheme https code 301


# =============================================================================
# 后端配置 - Caddy 服务器 (443端口) - 保留原有配置
# =============================================================================
backend caddy_servers_443
    mode tcp
    # 主 Caddy 服务器
    server caddy1_443 3.3.3.3:443 check inter 10s rise 2 fall 3
    
    # 备用 Caddy 服务器（可选）
    # server caddy2_443 9.9.9.9:443 check inter 10s rise 2 fall 3 backup
   
